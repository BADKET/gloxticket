{"version":3,"file":"close.js","sourceRoot":"/","sources":["utils/close.ts"],"names":[],"mappings":"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","sourcesContent":["import axios from \"axios\";\nimport {\n\tActionRow,\n\tActionRowBuilder,\n\tButtonBuilder,\n\tButtonInteraction,\n\tButtonStyle,\n\tChannelType,\n\tCollection,\n\tColorResolvable,\n\tCommandInteraction,\n\tComponentType,\n\tEmbedBuilder,\n\tGuildMember,\n\tMessage,\n\tMessageActionRowComponent,\n\tModalSubmitInteraction,\n\tTextChannel\n} from \"discord.js\";\nimport { generateMessages } from \"ticket-bot-transcript-uploader\";\nimport zlib from \"zlib\";\nimport { ExtendedClient, TicketType } from \"../structure\";\nimport { log } from \"./logs\";\n/*\nCopyright 2026 BADKET\n*/\n\ntype ticketType = {\n\tid: number;\n\tchannelid: string;\n\tmessageid: string;\n\tcategory: string;\n\tinvited: string;\n\treason: string;\n\tcreator: string;\n\tcreatedat: bigint;\n\tclaimedby: string | null;\n\tclaimedat: bigint | null;\n\tclosedby: string | null;\n\tclosedat: bigint | null;\n\tclosereason: string | null;\n\ttranscript: string | null;\n};\n\nexport async function close(\n\tinteraction: ButtonInteraction | CommandInteraction | ModalSubmitInteraction,\n\tclient: ExtendedClient,\n\treason?: string,\n\tdeleteTicket: boolean = false\n) {\n\tlet domain = \"https://m.ticket.pm/\";\n\n\tif (!interaction.channel || interaction.channel.type !== ChannelType.GuildText)\n\t\treturn await interaction.reply({\n\t\t\tcontent: \"This command can only be used in a ticket channel.\",\n\t\t\tephemeral: true\n\t\t});\n\n\tif (!client.config.closeOption.createTranscript) domain = client.locales.getSubValue(\"other\", \"unavailable\");\n\n\tconst ticket = await client.prisma.tickets.findUnique({\n\t\twhere: {\n\t\t\tchannelid: interaction.channel.id\n\t\t}\n\t});\n\tconst ticketClosed = ticket?.closedat && ticket.closedby;\n\tif (!ticket) return interaction.editReply({ content: \"Ticket not found\" }).catch((e) => console.log(e));\n\n\t// @TODO: Breaking change refactor happens here as well..\n\tconst ticketType = ticket ? (JSON.parse(ticket.category) as TicketType) : undefined;\n\n\tif (\n\t\tclient.config.closeOption.whoCanCloseTicket === \"STAFFONLY\" &&\n\t\t!(interaction.member as GuildMember | null)?.roles.cache.some(\n\t\t\t(r) => client.config.rolesWhoHaveAccessToTheTickets.includes(r.id) || ticketType?.staffRoles?.includes(r.id)\n\t\t)\n\t)\n\t\treturn interaction\n\t\t\t.editReply({\n\t\t\t\tcontent: client.locales.getValue(\"ticketOnlyClosableByStaff\")\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\tif (ticketClosed)\n\t\treturn interaction\n\t\t\t.editReply({\n\t\t\t\tcontent: client.locales.getValue(\"ticketAlreadyClosed\")\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\tlog(\n\t\t{\n\t\t\tLogType: \"ticketClose\",\n\t\t\tuser: interaction.user,\n\t\t\tticketId: ticket.id,\n\t\t\tticketChannelId: interaction.channel.id,\n\t\t\tticketCreatedAt: ticket.createdat,\n\t\t\treason: reason\n\t\t},\n\t\tclient\n\t);\n\n\t// Normally the user that closes the ticket will get posted here, but we'll do it when the ticket finalizes\n\n\tconst creator = ticket.creator;\n\tconst invited = JSON.parse(ticket.invited) as string[];\n\n\tinteraction.channel.permissionOverwrites\n\t\t.edit(creator, {\n\t\t\tViewChannel: false\n\t\t})\n\t\t.catch((e: unknown) => console.log(e));\n\tinvited.forEach(async (user) => {\n\t\t(interaction.channel as TextChannel | null)?.permissionOverwrites\n\t\t\t.edit(user, {\n\t\t\t\tViewChannel: false\n\t\t\t});\n\t});\n\n\tinteraction\n\t\t.editReply({\n\t\t\tcontent: client.locales.getValue(\"ticketCreatingTranscript\")\n\t\t})\n\t\t.catch((e) => console.log(e));\n\tasync function _close(id: string, ticket: ticketType) {\n\t\tif (client.config.closeOption.closeTicketCategoryId)\n\t\t\t(interaction.channel as TextChannel | null)?.setParent(client.config.closeOption.closeTicketCategoryId).catch((e) => console.log(e));\n\n\t\tconst msg = await interaction.channel?.messages.fetch(ticket.messageid);\n\t\tconst embed = new EmbedBuilder(msg?.embeds[0].data);\n\n\t\tconst rowAction = new ActionRowBuilder<ButtonBuilder>();\n\t\t(msg?.components[0] as ActionRow<MessageActionRowComponent>)?.components?.map((x) => {\n\t\t\tif (x.type !== ComponentType.Button) return;\n\t\t\tconst builder = new ButtonBuilder(x.data);\n\t\t\tif (x.customId === \"close\") builder.setDisabled(true);\n\t\t\tif (x.customId === \"close_askReason\") builder.setDisabled(true);\n\t\t\trowAction.addComponents(builder);\n\t\t});\n\n\t\tmsg\n\t\t\t?.edit({\n\t\t\t\tcontent: msg.content,\n\t\t\t\tembeds: [embed],\n\t\t\t\tcomponents: [rowAction]\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\t\t// Workaround for type handling, rewrite should not follow this.\n\t\tif (interaction.channel && interaction.channel.type !== ChannelType.GuildText)\n\t\t\tthrow Error(\"Close util used in a non-text channel\");\n\n\t\tif (client.config.closeOption.createTranscript) {\n\t\t\tinteraction.channel\n\t\t\t\t?.send({\n\t\t\t\t\tcontent: client.locales\n\t\t\t\t\t\t.getValue(\"ticketTranscriptCreated\")\n\t\t\t\t\t\t.replace(\n\t\t\t\t\t\t\t\"TRANSCRIPTURL\",\n\t\t\t\t\t\t\tdomain === client.locales.getSubValue(\"other\", \"unavailable\") ? client.locales.getSubValue(\"other\", \"unavailable\") : `<${domain}${id}>`\n\t\t\t\t\t\t)\n\t\t\t\t})\n\t\t\t\t.catch((e) => console.log(e));\n\t\t}\n\n\t\tticket = await client.prisma.tickets.update({\n\t\t\tdata: {\n\t\t\t\tclosedby: interaction.user.id,\n\t\t\t\tclosedat: Date.now(),\n\t\t\t\tclosereason: reason,\n\t\t\t\ttranscript: domain === client.locales.getSubValue(\"other\", \"unavailable\") ? client.locales.getSubValue(\"other\", \"unavailable\") : `${domain}${id}`\n\t\t\t},\n\t\t\twhere: {\n\t\t\t\tchannelid: interaction.channel?.id\n\t\t\t}\n\t\t});\n\n\t\tconst row = new ActionRowBuilder<ButtonBuilder>().addComponents(\n\t\t\tnew ButtonBuilder()\n\t\t\t\t.setCustomId(\"deleteTicket\")\n\t\t\t\t.setLabel(client.locales.getSubValue(\"other\", \"deleteTicketButtonMSG\"))\n\t\t\t\t.setStyle(ButtonStyle.Danger)\n\t\t\t\t.setDisabled(deleteTicket)\n\t\t);\n\t\tconst locale = client.locales;\n\t\tinteraction.channel\n\t\t\t?.send({\n\t\t\t\tembeds: [\n\t\t\t\t\tJSON.parse(\n\t\t\t\t\t\tJSON.stringify(locale.getSubRawValue(\"embeds\", \"ticketClosed\"))\n\t\t\t\t\t\t\t.replace(\"TICKETCOUNT\", ticket.id.toString())\n\t\t\t\t\t\t\t.replace(\"REASON\", (ticket.closereason ?? client.locales.getSubValue(\"other\", \"noReasonGiven\")).replace(/[\\n\\r]/g, \"\\\\n\"))\n\t\t\t\t\t\t\t.replace(\"CLOSERNAME\", interaction.user.tag)\n\t\t\t\t\t)\n\t\t\t\t],\n\t\t\t\tcomponents: client.config.closeOption.closeTicketCategoryId ? [] : [row]\n\t\t\t})\n\t\t\t.catch((e) => console.log(e));\n\n\t\tif (deleteTicket) {\n\t\t\tlog(\n\t\t\t\t{\n\t\t\t\t\tLogType: \"ticketDelete\",\n\t\t\t\t\tuser: interaction.user,\n\t\t\t\t\tticketId: ticket.id,\n\t\t\t\t\tticketCreatedAt: ticket.createdat,\n\t\t\t\t\ttranscriptURL: ticket.transcript ?? undefined\n\t\t\t\t},\n\t\t\t\tclient\n\t\t\t);\n\n\t\t\tinteraction.channel?.send({\n\t\t\t\tcontent: client.locales.getSubValue(\"embeds\", \"ticketClosed\", \"deleteTicketInfo\")\n\t\t\t});\n\t\t\tsetTimeout(() => interaction.channel?.delete().catch((e) => console.log(e)), 15000); // ticket will be deleted within 15 seconds\n\t\t}\n\n\t\tif (!client.config.closeOption.dmUser) return;\n\t\tconst footer = locale.getSubValue(\"embeds\", \"ticketClosedDM\", \"footer\", \"text\");\n\t\tconst ticketClosedDMEmbed = new EmbedBuilder({\n\t\t\tcolor: 0\n\t\t})\n\t\t\t.setColor((locale.getNoErrorSubValue(\"embeds\", \"ticketClosedDM\", \"color\") as ColorResolvable) ?? client.config.mainColor)\n\t\t\t.setDescription(\n\t\t\t\tclient.locales\n\t\t\t\t\t.getSubValue(\"embeds\", \"ticketClosedDM\", \"description\")\n\t\t\t\t\t.replace(\"TICKETCOUNT\", ticket.id.toString())\n\t\t\t\t\t.replace(\"TRANSCRIPTURL\", `${domain}${id}`)\n\t\t\t\t\t.replace(\"REASON\", ticket.closereason ?? client.locales.getSubValue(\"other\", \"noReasonGiven\"))\n\t\t\t\t\t.replace(\"CLOSERNAME\", interaction.user.tag)\n\t\t\t)\n\t\t\t.setFooter({\n\t\t\t\ttext: footer,\n\t\t\t\ticonURL: locale.getNoErrorSubValue(\"embeds\", \"ticketClosedDM\", \"footer\", \"iconUrl\")\n\t\t\t});\n\n\t\tclient.users.fetch(creator).then((user) => {\n\t\t\tuser\n\t\t\t\t.send({\n\t\t\t\t\tembeds: [ticketClosedDMEmbed]\n\t\t\t\t})\n\t\t\t\t.catch((e) => console.log(e));\n\t\t});\n\t}\n\n\tif (!client.config.closeOption.createTranscript) {\n\t\t_close(\"\", ticket);\n\t\treturn;\n\t}\n\n\tasync function fetchAll() {\n\t\tconst collArray: Collection<string, Message<true | false>>[] = [];\n\t\tlet lastID = (interaction.channel as TextChannel | null)?.lastMessageId;\n\t\tif (!lastID) return new Collection<string, Message<true | false>>();\n\n\t\t// Fetch the last message first to include it\n\t\tconst lastMsg = await interaction.channel?.messages.fetch(lastID).catch(() => null);\n\t\tif (lastMsg) {\n\t\t\tconst initialColl = new Collection<string, Message<true | false>>();\n\t\t\tinitialColl.set(lastMsg.id, lastMsg);\n\t\t\tcollArray.push(initialColl);\n\t\t}\n\n\t\twhile (true) {\n\t\t\tconst fetched: Collection<string, Message<true | false>> | undefined = await interaction.channel?.messages.fetch({ limit: 100, before: lastID });\n\t\t\tif (!fetched || fetched.size === 0) break;\n\t\t\tcollArray.push(fetched);\n\t\t\tlastID = fetched.last()?.id;\n\t\t\tif (fetched.size < 100) break;\n\t\t}\n\n\t\tif (collArray.length === 0) return new Collection<string, Message<true | false>>();\n\t\treturn collArray[0].concat(...collArray.slice(1));\n\t}\n\n\tconst messages = await fetchAll().catch(() => new Collection<string, Message<true | false>>());\n\tconst premiumKey = \"\";\n\n\ttry {\n\t\tconst messagesJSON = await generateMessages(messages, premiumKey, \"https://m.ticket.pm\");\n\t\tzlib.gzip(JSON.stringify(messagesJSON), async (err, compressed) => {\n\t\t\tif (err) {\n\t\t\t\tconsole.error(\"Zlib Error:\", err);\n\t\t\t\t_close(\"\", ticket);\n\t\t\t} else {\n\t\t\t\tconst ts = await axios\n\t\t\t\t\t.post(`${domain}upload?key=${premiumKey}&uuid=${client.config.uuidType}`, JSON.stringify(compressed), {\n\t\t\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\t\t\ttimeout: 5000 // 5 seconds timeout\n\t\t\t\t\t})\n\t\t\t\t\t.catch((e) => {\n\t\t\t\t\t\tconsole.error(\"Transcript Upload Error:\", e.message);\n\t\t\t\t\t\treturn null;\n\t\t\t\t\t});\n\t\t\t\t_close(ts?.data ?? \"\", ticket);\n\t\t\t}\n\t\t});\n\t} catch (e) {\n\t\tconsole.error(\"Transcript Generation Error:\", e);\n\t\t_close(\"\", ticket);\n\t}\n}\n\n/*\nCopyright 2026 BADKET\n*/\n"]}